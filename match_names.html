<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Match Names</title>
        <style>
            body {
                font: 12px sans-serif;
            }

            .tooltip {
                position: absolute;
                padding: 3px 8px;
                color: #fff;
                background-color: #000;
                border-radius: .25rem;
            }

            .bar {
                cursor: pointer;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }
        </style>

        <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
    </head>

    <body>
        <div id="figures" style="margin-bottom: 50px;"></div>
        <script>
            var margin = {top: 50, right: 150, bottom: 10, left: 100},
                width = 1000 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            var createFigure = function(cases) {

                var tooltip = d3.select("#figures").append('div')
                    .attr('class', 'tooltip')
                    .style('opacity', 0);

                var svg = d3.select("#figures").append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                
                var parseDate = d3.time.format('%Y-%m-%d');

                cases.forEach(function(c){
                    c["Court"] = courts[c.fips];
                    if(c.ArrestDate)
                        c["ArrestDate"] = parseDate.parse(c["ArrestDate"]);
                    c["OffenseDate"] = parseDate.parse(c["OffenseDate"]);
                    c["FiledDate"] = parseDate.parse(c["FiledDate"]);
                    c["Costs"] = parseFloat(c["Costs"] || '0');
                    c["Fine"] = parseFloat(c["Fine"] || '0');
                    c["Hearings"].forEach(function(h){
                        h["Date"] = parseDate.parse(h["Date"]);
                    });
                });

                console.log(cases);

                var startDate = d3.min(cases, function(c) {
                    return c["FiledDate"];
                });

                var endDate = d3.max(cases, function(c) {
                    return d3.max(c.Hearings, function(h) {
                        return h["Date"];
                    });
                });

                endDate = new Date(endDate.getFullYear() + 1, endDate.getMonth(), endDate.getDate());

                var x = d3.time.scale()
                    .range([0, width])
                    .clamp(1);
                
                var y = d3.scale.ordinal()
                    .rangeRoundBands([0, cases.length * 20], .1);

                var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient("top");

                var yAxis = d3.svg.axis()
                    .scale(y)
                    .orient("left");

                x.domain([startDate, endDate]);
                y.domain(cases.map(function(c) { return c["CaseNumber"]; }));

                svg.append("g")
                    .attr("class", "x axis")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);
                
                var bars = svg.selectAll()
                        .data(cases)
                    .enter().append("g")
                        .attr("class", "bar")
                        .attr("transform", function(c) { return "translate(0," + y(c.CaseNumber) + ")"; })
                    .on('mouseover', function (c, i) {
                        tooltip.transition()
                            .duration(200)
                            .style('opacity', 0.9);
                        
                        var matrix = this.getScreenCTM().translate(+x(c.FiledDate), +this.getAttribute('y'));

                        tooltip.html(function () {
                            var dob = parseDate.parse(c.DOB).toDateString().split(" ").slice(1, 3).join(" ");
                            var lines = [
                                [c.CaseNumber, " ", c.Court],
                                [c.Name, "&emsp; (", dob, ")"],
                                ["&emsp;&emsp; Race: ", c.Race],
                                ["&emsp;&emsp; Address: ", c.Address],
                                ["Offense: ", c.OffenseDate.toDateString().split(" ").slice(1, 4).join(" ")],
                                ["Filed: ", c.FiledDate.toDateString().split(" ").slice(1, 4).join(" ")]
                            ]
                            if(c.ArrestDate) {
                                lines.push(["Arrest: ", c.ArrestDate.toDateString().split(" ").slice(1, 4).join(" ")]);
                            }
                            lines = lines.concat([
                                ["Status: ", c.Status],
                                ["License Sus: " + c.OperatorLicenseSuspensionTime, " Days"],
                                ["Sentence: ", c.SentenceTime, " Days (", c.SentenceSuspendedTime, " Days Sus)"],
                                ["Attorney: ", c.DefenseAttorney]
                            ]);

                            var html = "";
                            for(var i=0; i<lines.length; i++) {
                                html += "<div>";
                                for(var j=0; j<lines[i].length; j++) {
                                    html += lines[i][j];
                                }
                                html += "</div>";
                            }
                            return html;
                        })
                        .style('left', function () {
                            return window.pageXOffset + matrix.e + 'px';
                        })
                        .style('top', function () {
                            return window.pageYOffset + matrix.f + 25 + 'px';
                        });
                    })
                    .on('mouseout', function () {
                        tooltip.transition()
                            .duration(50)
                            .style('opacity', 0);
                    });
                
                bars.append("rect")
                    .attr("height", y.rangeBand())
                    .attr("x", function(c) { return x(c.FiledDate); })
                    .attr("width", function(c) {
                        var lastHearing = d3.max(c.Hearings, function(h) {
                            return h.Date; 
                        });
                        return x(lastHearing) - x(c.FiledDate);
                    })
                    .style("fill", function(c) {
                        var notGuilty = ["Not Guilty", "Dismissed"];
                        return notGuilty.indexOf(c.FinalDisposition) === -1 ? "#FF7B7B" : "#7BFF7B";
                    });
                
                bars.append("rect")
                    .attr("y", y.rangeBand()*0.75)
                    .attr("height", y.rangeBand()*0.25)
                    .attr("x", function(c) {
                        var lastHearing = d3.max(c.Hearings, function(h) {
                            return h.Date; 
                        });
                        return x(lastHearing);
                    })
                    .attr("width", function(c) {
                        var fineCosts = c.Costs + c.Fine;
                        if (fineCosts > 0) {
                            var lastHearing = d3.max(c.Hearings, function(h) {
                                return h.Date; 
                            });
                            var fineCostsPaid = width;
                            if(c.FineCostsPaidDate) {
                                fineCostsPaid = x(parseDate.parse(c.FineCostsPaidDate));
                            }
                            return fineCostsPaid - x(lastHearing);
                        }
                        return 0;
                    })
                    .style("fill", "#FF7B7B");
                
                bars.append("text")
                    .attr("x", function(c) { return x(c.FiledDate); })
                    .attr("y", y.rangeBand() * 0.25)
                    .attr("dy", "0.5em")
                    .attr("dx", "0.5em")
                    .style("font" ,"10px sans-serif")
                    .style("text-anchor", "begin")
                    .text(function(c) {
                        var text = c.Charge + " - " + c.FinalDisposition;
                        var fineCosts = c.Costs + c.Fine;
                        if (fineCosts > 0) {
                            text += " ($" + fineCosts;
                            if(c.FineCostsPaidDate) {
                                text += " paid " + c.FineCostsPaidDate + ")";
                            } else {
                                text += " due on " + c.FineCostsDue + ")";
                            }
                        }
                        return text;
                    });
                
                bars.selectAll()
                        .data(function(c) { return c.Hearings; })
                    .enter().append("line")
                        .attr("x1", function(h) { return x(h.Date); })
                        .attr("x2", function(h) { return x(h.Date); })
                        .attr("y1", y.rangeBand() * 0.75)
                        .attr("y2", y.rangeBand())
                        .style("stroke", "#000");

            };

            var courts = {};
            d3.csv("data/district_courts.csv", function(error, data) {
                data.forEach(function(d) {
                    courts[d.fips] = d.name;
                });

                d3.json("match_names.json", function(error, data) {
                    data.forEach(function(d) {
                        createFigure(d);
                    });
                });
            });
        </script>
    </body>
</html>